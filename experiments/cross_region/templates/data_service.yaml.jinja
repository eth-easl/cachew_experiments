{% set ip_mapping = {
} %}

kind: ReplicaSet
apiVersion: apps/v1
metadata:
  name: data-service-dispatcher
spec:
  replicas: 1
  selector:
    matchLabels:
      name: data-service-dispatcher
  template:
    metadata:
      labels:
        name: data-service-dispatcher
    spec:
      containers:
      - name: tensorflow
        image: {{ image }}
        ports:
        - containerPort: {{ port }}
        args:
        - "--port={{ port }}"
        - "--is_dispatcher=true"
        - "--vlog={{ vlog }}"

      env:
        - name: TF_CPP_MIN_LOG_LEVEL
          value: "0"
        - name: TF_CPP_MAX_VLOG_LEVEL
          value: "{{ vlog }}"

---

{% for worker_name, worker_ip in ip_mapping.items() %}
kind: ReplicaSet
apiVersion: extensions/v1beta1
metadata:
  name: {{ worker_name }}
spec:
  replicas: 1
  selector:
    matchLabels:
      name: {{ worker_name }}
  template:
    metadata:
      labels:
        name: {{ worker_name }}
    spec:
      containers:
      - name: tensorflow
        image: {{ image }}
        ports:
        - containerPort: {{ port }}
        args:
        - "--port={{ port }}"
        - "--is_dispatcher=false"
        - "--dispatcher_address=data-service-dispatcher:{{ port }}"
        - "--vlog={{ vlog }}"
        - "--worker_address={{ worker_ip }}:{{ port }}"
        env:
        - name: TF_CPP_MIN_LOG_LEVEL
          value: "0"
        - name: TF_CPP_MAX_VLOG_LEVEL
          value: "{{ vlog }}"

---
{% endfor %}